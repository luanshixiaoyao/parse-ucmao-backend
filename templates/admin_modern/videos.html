{% extends "admin_modern/base.html" %}

{% block title %}视频库管理 - Ucmao Admin{% endblock %}

{% block content %}
<div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
        <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">视频库管理</h1>
        <p class="text-slate-500 mt-1">管理视频显示状态，支持单条或批量控制前端可见性。</p>
    </div>
</div>

<!-- Filters -->
<div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 mb-8">
    <form method="GET" class="space-y-4">
        <div class="flex flex-wrap gap-4 items-center">
            <!-- Main Search -->
            <div class="flex-1 min-w-[300px] relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" name="search" value="{{ search }}" 
                    class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-medium text-sm"
                    placeholder="搜索标题或视频ID...">
            </div>

            <!-- Platform Selector -->
            <div class="relative">
                <i class="fas fa-layer-group absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 z-10"></i>
                <select name="platform" class="pl-11 pr-10 py-3 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-bold text-slate-600 appearance-none text-sm min-w-[140px]">
                    <option value="">所有平台</option>
                    <option value="抖音" {{ 'selected' if platform == '抖音' }}>抖音</option>
                    <option value="快手" {{ 'selected' if platform == '快手' }}>快手</option>
                    <option value="小红书" {{ 'selected' if platform == '小红书' }}>小红书</option>
                    <option value="哔哩哔哩" {{ 'selected' if platform == '哔哩哔哩' }}>哔哩哔哩</option>
                </select>
                <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none text-[10px]"></i>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center space-x-2">
                <button type="submit" class="px-8 py-3 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 flex items-center">
                    <i class="fas fa-search mr-2"></i>查找
                </button>
                {% if search or platform or visibility or start_date or end_date or min_score or max_score %}
                <a href="{{ url_for('admin_modern.videos') }}" class="px-6 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition-all text-sm">重置</a>
                {% endif %}
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="flex flex-wrap gap-4 pt-4 border-t border-slate-50 items-center">
            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mr-2">高级筛选:</div>
            
            <!-- Visibility Selector -->
            <div class="relative">
                <i class="fas fa-eye absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 z-10 text-xs"></i>
                <select name="visibility" class="pl-9 pr-8 py-1.5 bg-slate-50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-bold text-slate-600 appearance-none text-[11px] min-w-[100px]">
                    <option value="">全部状态</option>
                    <option value="1" {{ 'selected' if visibility == '1' }}>仅可见</option>
                    <option value="0" {{ 'selected' if visibility == '0' }}>仅隐藏</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none text-[8px]"></i>
            </div>

            <!-- Date Range -->
            <div class="flex items-center space-x-2 bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                <i class="far fa-calendar-alt text-slate-400 ml-2"></i>
                <input type="date" name="start_date" value="{{ start_date }}" class="bg-transparent border-none outline-none text-xs font-bold text-slate-600 focus:ring-0 p-0 w-28">
                <span class="text-slate-300">至</span>
                <input type="date" name="end_date" value="{{ end_date }}" class="bg-transparent border-none outline-none text-xs font-bold text-slate-600 focus:ring-0 p-0 w-28">
            </div>

            <!-- Score Range -->
            <div class="flex items-center space-x-2 bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                <i class="fas fa-star text-slate-400 ml-2"></i>
                <input type="number" name="min_score" value="{{ min_score }}" placeholder="最小积分" class="bg-transparent border-none outline-none text-xs font-bold text-slate-600 focus:ring-0 p-0 w-16 text-center">
                <span class="text-slate-300">-</span>
                <input type="number" name="max_score" value="{{ max_score }}" placeholder="最大积分" class="bg-transparent border-none outline-none text-xs font-bold text-slate-600 focus:ring-0 p-0 w-16 text-center">
            </div>
        </div>
    </form>
</div>

<!-- Bulk Actions -->
<div id="bulk-actions" class="hidden mb-6 bg-white border border-indigo-100 p-5 rounded-[2rem] shadow-xl shadow-indigo-50/50 flex flex-col md:flex-row items-center gap-4 animate-fade-in sticky top-4 z-[90]">
    <div class="flex items-center space-x-3 pr-4 border-r border-slate-100">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white">
            <span id="selected-count" class="font-black text-lg">0</span>
        </div>
        <div class="flex flex-col">
            <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest leading-none mb-1">已选择</div>
            <div id="selection-msg" class="text-indigo-600 text-[10px] font-bold whitespace-nowrap cursor-pointer hover:underline" onclick="toggleSelectAllMode()">
                <span id="selection-msg-text">当前页结果</span>
            </div>
        </div>
    </div>
    
    <div class="flex flex-wrap gap-2 flex-1">
        <!-- 复制操作 (所有账号可用) -->
        <button onclick="bulkCopy('title')" class="px-4 py-2.5 bg-slate-50 text-slate-600 rounded-xl text-sm font-bold hover:bg-indigo-50 hover:text-indigo-600 transition-all flex items-center">
            <i class="fas fa-copy mr-2 opacity-50"></i>复制标题
        </button>
        <button onclick="bulkCopy('cover')" class="px-4 py-2.5 bg-slate-50 text-slate-600 rounded-xl text-sm font-bold hover:bg-indigo-50 hover:text-indigo-600 transition-all flex items-center">
            <i class="fas fa-image mr-2 opacity-50"></i>封面链接
        </button>
        <button onclick="bulkCopy('video')" class="px-4 py-2.5 bg-slate-50 text-slate-600 rounded-xl text-sm font-bold hover:bg-indigo-50 hover:text-indigo-600 transition-all flex items-center">
            <i class="fas fa-link mr-2 opacity-50"></i>视频链接
        </button>
        <button onclick="bulkCopy('all')" class="px-4 py-2.5 bg-indigo-50 text-indigo-600 rounded-xl text-sm font-black hover:bg-indigo-100 transition-all flex items-center">
            <i class="fas fa-share-alt mr-2"></i>全部信息
        </button>

        <div class="w-px h-8 bg-slate-100 mx-2 self-center"></div>

        <!-- 状态/数据修改 (限制权限) -->
        <button onclick="bulkEditScore()" class="px-4 py-2.5 bg-amber-50 text-amber-600 rounded-xl text-sm font-bold hover:bg-amber-100 transition-all flex items-center {{ 'opacity-50' if session.get('admin_role') != 'admin' }}">
            <i class="fas fa-plus-minus mr-2"></i>加减积分
        </button>
        <button onclick="bulkVisibility(true)" class="px-4 py-2.5 bg-emerald-50 text-emerald-600 rounded-xl text-sm font-bold hover:bg-emerald-100 transition-all flex items-center {{ 'opacity-50' if session.get('admin_role') != 'admin' }}">
            <i class="fas fa-eye mr-2"></i>设为可见
        </button>
        <button onclick="bulkVisibility(false)" class="px-4 py-2.5 bg-slate-100 text-slate-500 rounded-xl text-sm font-bold hover:bg-slate-200 transition-all flex items-center {{ 'opacity-50' if session.get('admin_role') != 'admin' }}">
            <i class="fas fa-eye-slash mr-2"></i>设为隐藏
        </button>
        <button onclick="bulkDelete()" class="px-4 py-2.5 bg-rose-50 text-rose-600 rounded-xl text-sm font-bold hover:bg-rose-100 transition-all flex items-center {{ 'opacity-50' if session.get('admin_role') != 'admin' }}">
            <i class="fas fa-trash-alt mr-2"></i>批量删除
        </button>
    </div>

    <button onclick="clearSelection()" class="p-2 text-slate-300 hover:text-slate-500 transition-colors">
        <i class="fas fa-times-circle text-2xl"></i>
    </button>
</div>

<!-- Video List -->
<div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-slate-50/50 text-slate-500 text-xs font-bold uppercase tracking-widest">
                <tr>
                    <th class="px-4 py-3 w-8">
                        <input type="checkbox" id="select-all" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" onclick="toggleAll(this)">
                    </th>
                    <th class="px-4 py-3">封面</th>
                    <th class="px-4 py-3">视频信息 (点击标题编辑)</th>
                    <th class="px-4 py-3">解析用户</th>
                    <th class="px-4 py-3 cursor-pointer hover:text-indigo-600 transition-colors" onclick="sortBy('platform')">
                        平台 {% if sort_by == 'platform' %}<i class="fas fa-sort-{{ 'down' if order == 'desc' else 'up' }}"></i>{% endif %}
                    </th>
                    <th class="px-4 py-3 text-center cursor-pointer hover:text-indigo-600 transition-colors" onclick="sortBy('score')">
                        积分 {% if sort_by == 'score' %}<i class="fas fa-sort-{{ 'down' if order == 'desc' else 'up' }}"></i>{% endif %}
                    </th>
                    <th class="px-4 py-3 cursor-pointer hover:text-indigo-600 transition-colors" onclick="sortBy('create_at')">
                        创建时间 {% if sort_by == 'create_at' %}<i class="fas fa-sort-{{ 'down' if order == 'desc' else 'up' }}"></i>{% endif %}
                    </th>
                    <th class="px-4 py-3 text-center">前端可见</th>
                    <th class="px-4 py-3 text-center">操作</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
                {% for video in videos %}
                <tr class="hover:bg-slate-50/50 transition-colors group">
                    <td class="px-4 py-4">
                        <input type="checkbox" class="video-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="{{ video.video_id }}" onclick="updateSelection()">
                    </td>
                    <td class="px-4 py-4">
                        {% if video.cover_url %}
                        <div class="relative w-20 h-20 cursor-pointer group/thumb shadow-md rounded-2xl overflow-hidden" onclick="playVideo('{{ video.video_url }}', '{{ video.title }}')">
                            <img src="{{ video.cover_url }}" class="w-full h-full object-cover transition-transform group-hover/thumb:scale-110" onerror="this.src='{{ url_for('static', filename='images/default-cover.png') }}'; this.onerror=null;">
                            <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover/thumb:opacity-100 transition-opacity">
                                <i class="fas fa-play text-white text-xl"></i>
                            </div>
                        </div>
                        {% else %}
                        <div class="w-20 h-20 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-400 text-xl font-bold cursor-pointer shadow-inner" onclick="playVideo('{{ video.video_url }}', '{{ video.title }}')">
                            <i class="fas fa-video"></i>
                        </div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <div class="max-w-md">
                            <div class="font-bold text-slate-800 text-base mb-1 {{ 'cursor-text hover:text-indigo-600' if session.get('admin_role') == 'admin' else '' }} transition-colors flex items-start group/title" {% if session.get('admin_role') == 'admin' %}onclick="showEditModal('title', '{{ video.video_id }}', '{{ video.title or '' }}', this)"{% endif %}>
                                <span class="title-text line-clamp-3 leading-snug">{{ video.title or '未命名视频' }}</span>
                                {% if session.get('admin_role') == 'admin' %}
                                <i class="fas fa-edit ml-2 mt-1 text-slate-300 opacity-0 group-hover/title:opacity-100 transition-opacity text-[10px] flex-shrink-0"></i>
                                {% endif %}
                            </div>
                            <div class="text-[10px] text-slate-400 font-mono tracking-tighter">{{ video.video_id }}</div>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        {% if video.last_user_name %}
                        <a href="{{ url_for('admin_modern.users', search=video.last_user_name) }}" class="text-indigo-600 hover:text-indigo-800 font-bold hover:underline transition-all text-sm whitespace-nowrap">
                            {{ video.last_user_name }}
                        </a>
                        {% else %}
                        <span class="text-slate-300 text-sm">系统/匿名</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">{{ video.platform }}</span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="{{ 'cursor-pointer hover:bg-indigo-50' if session.get('admin_role') == 'admin' else '' }} py-1 rounded-lg transition-colors group/score" {% if session.get('admin_role') == 'admin' %}onclick="showEditModal('score', '{{ video.video_id }}', '{{ video.score }}', this)"{% endif %}>
                            <span class="score-value text-indigo-600 font-black text-lg">{{ video.score }}</span>
                            {% if session.get('admin_role') == 'admin' %}
                            <i class="fas fa-edit ml-1 text-slate-300 opacity-0 group-hover/score:opacity-100 transition-opacity text-[10px]"></i>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-4 py-4 text-[11px] text-slate-400 font-medium whitespace-nowrap">
                        {{ video.create_at.strftime('%Y-%m-%d %H:%M') if video.create_at else '-' }}
                    </td>
                    <td class="px-4 py-4 text-center">
                        {% if video.is_visible %}
                        <button {% if session.get('admin_role') == 'admin' %}onclick="toggleVisibility('{{ video.video_id }}', 1, this)"{% else %}disabled{% endif %} 
                            class="px-4 py-1.5 bg-emerald-50 text-emerald-600 rounded-full text-xs font-black hover:bg-emerald-100 transition-all {{ 'cursor-pointer' if session.get('admin_role') == 'admin' else 'cursor-default' }}">
                            可见
                        </button>
                        {% else %}
                        <button {% if session.get('admin_role') == 'admin' %}onclick="toggleVisibility('{{ video.video_id }}', 0, this)"{% else %}disabled{% endif %} 
                            class="px-4 py-1.5 bg-slate-100 text-slate-400 rounded-full text-xs font-black hover:bg-slate-200 transition-all {{ 'cursor-pointer' if session.get('admin_role') == 'admin' else 'cursor-default' }}">
                            隐藏
                        </button>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            {% if session.get('admin_role') == 'admin' %}
                            <button onclick="deleteVideo('{{ video.video_id }}')" class="text-slate-300 hover:text-red-500 transition-colors" title="删除记录">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            {% else %}
                            <span class="text-slate-200 text-xs">-</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not videos %}
                <tr><td colspan="9" class="px-8 py-32 text-center text-slate-400 font-medium">没有找到匹配的记录</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total > limit %}
    <div class="px-8 py-6 border-t border-slate-100 flex items-center justify-between bg-slate-50/30">
        <div class="text-sm text-slate-500 font-medium">共 {{ total }} 条记录</div>
        <div class="flex space-x-2">
            {% if page > 1 %}
            <a href="{{ url_for('admin_modern.videos', page=page-1, search=search, platform=platform, visibility=visibility, start_date=start_date, end_date=end_date, min_score=min_score, max_score=max_score, sort_by=sort_by, order=order) }}" class="px-4 py-2 bg-white border border-slate-200 rounded-xl font-bold hover:bg-indigo-50 transition-all">上一页</a>
            {% endif %}
            {% if total > page * limit %}
            <a href="{{ url_for('admin_modern.videos', page=page+1, search=search, platform=platform, visibility=visibility, start_date=start_date, end_date=end_date, min_score=min_score, max_score=max_score, sort_by=sort_by, order=order) }}" class="px-4 py-2 bg-white border border-slate-200 rounded-xl font-bold hover:bg-indigo-50 transition-all">下一页</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all animate-fade-in">
        <div class="p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 id="edit-modal-title" class="text-xl font-bold text-slate-800">编辑内容</h3>
                <button onclick="hideEditModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label id="edit-modal-label" class="block text-sm font-bold text-slate-500 mb-2 ml-1">新值</label>
                    <!-- 标题编辑用 textarea -->
                    <textarea id="edit-modal-textarea" class="hidden w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-medium text-slate-700 h-32 resize-none"></textarea>
                    <!-- 积分编辑用 input -->
                    <input type="number" id="edit-modal-input" class="hidden w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-black text-2xl text-slate-700">
                </div>
            </div>
        </div>
        <div class="bg-slate-50 p-6 flex justify-end space-x-3">
            <button onclick="hideEditModal()" class="px-6 py-3 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition-all">取消</button>
            <button id="edit-modal-confirm" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">确认修改</button>
        </div>
    </div>
</div>

<!-- Bulk Score Modal -->
<div id="bulk-score-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all animate-fade-in">
        <div class="p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-800">批量调整积分</h3>
                <button onclick="hideBulkScoreModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-slate-500 leading-relaxed">为选中的 <span id="bulk-score-count" class="font-black text-indigo-600">0</span> 个视频增加或减少积分。输入正数（如 10）加分，输入负数（如 -10）扣分。</p>
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">调整数值</label>
                    <input type="number" id="bulk-score-input" value="10" class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-black text-2xl text-slate-700 text-center">
                </div>
            </div>
        </div>
        <div class="bg-slate-50 p-6 flex justify-end space-x-3">
            <button onclick="hideBulkScoreModal()" class="px-6 py-3 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition-all">取消</button>
            <button id="bulk-score-confirm" class="px-8 py-3 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600 transition-all shadow-lg shadow-amber-100">确认批量更新</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->

<script>
    let currentEditData = null;
    let selectAllMode = false;
    const totalResults = {{ total }};

    function toggleSelectAllMode() {
        selectAllMode = !selectAllMode;
        const msgText = document.getElementById('selection-msg-text');
        const countBadge = document.getElementById('selected-count');
        
        if (selectAllMode) {
            msgText.innerText = '全部结果 (含本页及其他页)';
            countBadge.innerText = totalResults;
            showToast('已切换至全选模式');
        } else {
            msgText.innerText = '当前页结果';
            updateSelection();
        }
    }

    function showEditModal(type, id, value, element) {
        currentEditData = { type, id, element };
        const modal = document.getElementById('edit-modal');
        const title = document.getElementById('edit-modal-title');
        const label = document.getElementById('edit-modal-label');
        const input = document.getElementById('edit-modal-input');
        const textarea = document.getElementById('edit-modal-textarea');
        
        // 隐藏两个输入框，待会根据类型显示其中一个
        input.classList.add('hidden');
        textarea.classList.add('hidden');

        let activeInput;
        if (type === 'title') {
            title.innerText = '编辑视频标题';
            label.innerText = '标题内容';
            textarea.classList.remove('hidden');
            textarea.value = value;
            activeInput = textarea;
        } else {
            title.innerText = '编辑视频积分';
            label.innerText = '积分数值';
            input.classList.remove('hidden');
            input.value = value;
            activeInput = input;
        }
        
        modal.classList.remove('hidden');
        activeInput.focus();

        document.getElementById('edit-modal-confirm').onclick = () => {
            const newValue = activeInput.value;
            if (type === 'score' && isNaN(parseInt(newValue))) return showToast('请输入数字', 'error');
            
            const apiUrl = type === 'title' ? "{{ url_for('admin_modern.update_video_title') }}" : "{{ url_for('admin_modern.update_video_score') }}";
            const body = { video_id: id };
            body[type] = type === 'score' ? parseInt(newValue) : newValue;

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    const spanClass = type === 'title' ? '.title-text' : '.score-value';
                    currentEditData.element.querySelector(spanClass).innerText = newValue;
                    showToast('更新成功');
                    hideEditModal();
                } else {
                    showToast(data.message, 'error');
                }
            });
        };
    }

    function hideEditModal() {
        document.getElementById('edit-modal').classList.add('hidden');
        currentEditData = null;
    }

    function sortBy(field) {
        const url = new URL(window.location.href);
        const currentSort = url.searchParams.get('sort_by');
        const currentOrder = url.searchParams.get('order');
        
        url.searchParams.set('sort_by', field);
        url.searchParams.set('order', (currentSort === field && currentOrder === 'desc') ? 'asc' : 'desc');
        // 关键修复：切换排序时必须回到第 1 页，否则看到的不是最顶部的结果
        url.searchParams.set('page', '1');
        
        window.location.href = url.toString();
    }

    function toggleVisibility(videoId, currentStatus, btn) {
        if (userRole !== 'admin') return;
        const newStatus = currentStatus === 1 ? 0 : 1;
        fetch("{{ url_for('admin_modern.toggle_visibility') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_id: videoId, is_visible: newStatus })
        }).then(r => r.json()).then(data => {
            if(data.success) {
                if(newStatus === 1) {
                    btn.className = 'px-4 py-1.5 bg-emerald-50 text-emerald-600 rounded-full text-xs font-black hover:bg-emerald-100 transition-all cursor-pointer';
                    btn.textContent = '可见';
                } else {
                    btn.className = 'px-4 py-1.5 bg-slate-100 text-slate-400 rounded-full text-xs font-black hover:bg-slate-200 transition-all cursor-pointer';
                    btn.textContent = '隐藏';
                }
                btn.setAttribute('onclick', `toggleVisibility('${videoId}', ${newStatus}, this)`);
                showToast(newStatus ? '已设置为可见' : '已成功隐藏');
            }
        });
    }

    const userRole = "{{ session.get('admin_role', 'viewer') }}";

    function bulkVisibility(status) {
        if (userRole !== 'admin') return showToast('权限不足：演示账号无法执行批量操作', 'error');
        const selected = selectAllMode ? [] : Array.from(document.querySelectorAll('.video-checkbox:checked')).map(cb => cb.value);
        if(!selectAllMode && !selected.length) return;
        
        const actionText = status ? '全部可见' : '全部隐藏';
        const targetCount = selectAllMode ? totalResults : selected.length;
        const msg = selectAllMode ? `确定要将筛选出的全部 ${totalResults} 条记录设置为${actionText}吗？` : `确定要将选中的 ${selected.length} 条记录设置为${actionText}吗？`;

        showConfirm(msg, () => {
            const urlParams = new URLSearchParams(window.location.search);
            fetch("{{ url_for('admin_modern.bulk_visibility') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    video_ids: selected, 
                    is_visible: status,
                    search: urlParams.get('search') || '',
                    platform: urlParams.get('platform') || '',
                    visibility: urlParams.get('visibility') || '',
                    start_date: urlParams.get('start_date') || '',
                    end_date: urlParams.get('end_date') || '',
                    min_score: urlParams.get('min_score') || '',
                    max_score: urlParams.get('max_score') || ''
                })
            }).then(r => r.json()).then(data => {
                if(data.success) {
                    showToast(`批量操作成功: ${data.count} 条`);
                    setTimeout(() => location.reload(), 1000);
                }
            });
        });
    }

    function bulkCopy(type) {
        if (selectAllMode) {
            return showToast('全选模式暂不支持复制，请切换回本页模式或直接分页复制', 'error');
        }
        const selectedCheckboxes = Array.from(document.querySelectorAll('.video-checkbox:checked'));
        if(!selectedCheckboxes.length) return;
        // ... (rest of the copy logic remains same)

        let content = '';
        selectedCheckboxes.forEach((cb, index) => {
            const row = cb.closest('tr');
            const title = row.querySelector('.title-text').innerText;
            const cover = row.querySelector('img') ? row.querySelector('img').src : '无封面';
            // 从 playVideo 的参数中提取 URL（这是一个简单的方法）
            const playBtn = row.querySelector('button[onclick^="playVideo"]');
            const videoUrl = playBtn.getAttribute('onclick').split("'")[1];

            if (type === 'title') content += title + '\n';
            else if (type === 'cover') content += cover + '\n';
            else if (type === 'video') content += videoUrl + '\n';
            else if (type === 'all') {
                content += `标题：${title}\n封面：${cover}\n视频：${videoUrl}\n\n`;
            }
        });

        navigator.clipboard.writeText(content.trim()).then(() => {
            showToast('已复制到剪贴板');
        }).catch(err => {
            showToast('复制失败', 'error');
        });
    }

    function bulkEditScore() {
        if (userRole !== 'admin') return showToast('权限不足：演示账号无法执行批量操作', 'error');
        const selected = selectAllMode ? [] : Array.from(document.querySelectorAll('.video-checkbox:checked')).map(cb => cb.value);
        if(!selectAllMode && !selected.length) return;

        const targetCount = selectAllMode ? totalResults : selected.length;
        document.getElementById('bulk-score-count').innerText = targetCount;
        const modal = document.getElementById('bulk-score-modal');
        const input = document.getElementById('bulk-score-input');
        modal.classList.remove('hidden');
        input.focus();
        input.select();

        document.getElementById('bulk-score-confirm').onclick = () => {
            const val = parseInt(input.value);
            if (isNaN(val)) return showToast('请输入有效的数字', 'error');

            const urlParams = new URLSearchParams(window.location.search);
            fetch("{{ url_for('admin_modern.bulk_update_score') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    video_ids: selected, 
                    score_delta: val,
                    search: urlParams.get('search') || '',
                    platform: urlParams.get('platform') || '',
                    visibility: urlParams.get('visibility') || '',
                    start_date: urlParams.get('start_date') || '',
                    end_date: urlParams.get('end_date') || '',
                    min_score: urlParams.get('min_score') || '',
                    max_score: urlParams.get('max_score') || ''
                })
            }).then(r => r.json()).then(data => {
                if(data.success) {
                    showToast(`批量更新成功`);
                    hideBulkScoreModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message, 'error');
                }
            });
        };
    }

    function hideBulkScoreModal() {
        document.getElementById('bulk-score-modal').classList.add('hidden');
    }

    function bulkDelete() {
        if (userRole !== 'admin') return showToast('权限不足：演示账号无法执行批量操作', 'error');
        const selected = selectAllMode ? [] : Array.from(document.querySelectorAll('.video-checkbox:checked')).map(cb => cb.value);
        if(!selectAllMode && !selected.length) return;

        const targetCount = selectAllMode ? totalResults : selected.length;
        showConfirm(`确定要永久删除【${selectAllMode ? '筛选出的全部' : '选中的'}】 ${targetCount} 条记录吗？此操作不可撤销！`, () => {
            const urlParams = new URLSearchParams(window.location.search);
            fetch("{{ url_for('admin_modern.bulk_delete') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    video_ids: selected,
                    search: urlParams.get('search') || '',
                    platform: urlParams.get('platform') || '',
                    visibility: urlParams.get('visibility') || '',
                    start_date: urlParams.get('start_date') || '',
                    end_date: urlParams.get('end_date') || '',
                    min_score: urlParams.get('min_score') || '',
                    max_score: urlParams.get('max_score') || ''
                })
            }).then(r => r.json()).then(data => {
                if(data.success) {
                    showToast(`批量删除成功: ${data.count} 条`);
                    setTimeout(() => location.reload(), 1000);
                }
            });
        }, '高危批量删除');
    }

    function toggleAll(master) {
        document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = master.checked);
        updateSelection();
    }

    function updateSelection() {
        const selectedCount = document.querySelectorAll('.video-checkbox:checked').length;
        const bulkBar = document.getElementById('bulk-actions');
        document.getElementById('selected-count').innerText = selectedCount;
        
        if(selectedCount > 0) {
            bulkBar.classList.remove('hidden');
            // 如果不是全勾选且当前是全选模式，强制切回本页模式
            if (selectedCount < document.querySelectorAll('.video-checkbox').length && selectAllMode) {
                selectAllMode = false;
                document.getElementById('selection-msg-text').innerText = '当前页结果';
            }
        } else {
            bulkBar.classList.add('hidden');
            selectAllMode = false;
            document.getElementById('selection-msg-text').innerText = '当前页结果';
        }
    }

    function clearSelection() {
        document.getElementById('select-all').checked = false;
        toggleAll(document.getElementById('select-all'));
        selectAllMode = false;
        document.getElementById('selection-msg-text').innerText = '当前页结果';
    }

    function deleteVideo(videoId) {
        showConfirm('确定要永久删除这条视频记录吗？此操作不可撤销。', () => {
            fetch("{{ url_for('admin_modern.delete_video') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_id: videoId })
            }).then(r => r.json()).then(data => {
                if(data.success) { showToast('已删除'); setTimeout(() => location.reload(), 800); }
            });
        });
    }
</script>
{% endblock %}
